<section class="booking-section">
	<h1>Booking Overview</h1>
	<div class="booking">
		<article class="booking__host">
			<div class="booking__host-left">
				<h2>Your Host</h2>
				<%= link_to couch_path(@couch) do %>
					<%= image_tag('profile.jpg', class: 'booking__host-image') %>
				<% end %>
			</div>
			<div class="booking__host-right">
				<h3 class="booking__host-name">
					<%= @couch.user.first_name %>, <%= @couch.user.calculated_age %>
					<span><%= @couch.user.pronouns %></span>
				</h3>
				<div class="request__chat chat-icon__wrap">
					<% if @chat.nil? %>
						<%= button_to chats_path(user_sender_id: current_user.id, user_receiver_id: @host.id), method: :post do %>
							<%= image_tag('icons/message.svg', class: 'chat-icon') %>
						<% end %>
					<% else %>
						<%= link_to chat_path(@chat) do %>
							<%= image_tag('icons/message.svg', class: 'chat-icon') %>
						<% end %>
					<% end %>
				</div>
			</div>
		</article>

		<div class="booking__wrap">
			<article class="booking__info">
				<div class="booking__details">
					<h2>Travel Details</h2>
					<ul class="booking__details-list">
						<li>
							<%= image_tag('icons/calendar.svg') %>
							<%= @booking.start_date.strftime("%b %d") %> - <%= @booking.end_date.strftime("%b %d, %Y") %>
						</li>
						<li>
							<%= image_tag('icons/home.svg') %>
							<%= @booking.status.capitalize %>
						</li>
						<li>
							<%= image_tag('icons/euro.svg') %>
							<% if @booking.payments.where(status: 1).any? %>
								<%= 'Booking has been paid.' %>
							<% elsif @booking.payments.where(status: 1).empty? && @booking.confirmed? %>
								<%= 'Awaiting payment to give access to address.' %>
							<% elsif @booking.pending? || @booking.pending_reconfirmation? %>
								<%= 'Waiting for the host to confirm.' %>
							<% elsif @booking.completed? %>
								<%= 'Booking has been paid.' %>
							<% end %>
						</li>
						<li>
							<%= image_tag('icons/people.svg') %>
							<%= pluralize @booking.number_travellers, "Traveller" %>
						</li>
					</ul>
				</div>

				<div class="booking__accomodation">
					<h2>Accomodation</h2>
					<ul class="booking__accomodation-list">
						<% @couch.facilities.each do |facility| %>
							<% if facility.image.attached? %>
								<li>
									<%= image_tag ('icons/armchair.svg') %>
									<%= facility.name %>
								</li>
							<% else %>
								<li>
									<%= facility.name %>
								</li>
							<% end %>
						<% end %>
					</ul>
				</div>
			</article>

			<article class="booking__location">
				<h2>Location</h2>
				<ul class="booking__address">
					<li class="booking__pin">
						<%= image_tag ('icons/city.svg') %>
						<p><%= @couch.user.city.name %></p>
					</li>
					<li class="booking__pin">
						<% if !@booking.cancelled? %>
							<%= image_tag ('icons/pin.svg') %>
							<% if @booking.confirmed? && @booking.payments.where(status: 1).any? %>
								<p><%= @couch.user.address %></p>
							<% elsif @booking.confirmed? %>
								<p>Pay now to get access to your hosts address!</p>
							<% elsif @booking.pending? || @booking.pending_reconfirmation? %>
								<p>You will see your hosts address once the booking is confirmed and paid.</p>
							<% elsif @booking.completed? %>
								<p><%= @couch.user.address %></p>
							<% end %>
						<% end %>
					</li>
				</ul>
				<% if @booking.confirmed? && @booking.payments.where(status: 1).any? %>
				<div class="booking__map"
							data-controller="map"
							data-map-marker-value="<%= @marker.to_json %>"
							data-map-api-key-value="<%= ENV['MAPBOX_API_KEY'] %>"></div>
				<% end %>
			</article>

			<div class="booking__links">
				<% if @booking.pending? || @booking.pending_reconfirmation? %>
				<%= link_to 'Update Request', edit_booking_path(@booking), class: 'booking__update' %>
				<%= button_to 'Cancel Request', cancel_booking_path(@booking), data: { turbo_confirm: 'Are you sure?' }, method: :patch, class: 'booking__decline' %>
				<% elsif @booking.confirmed? && @booking.payments.where(status: 1).empty? %>
					<%= link_to 'Change Booking', edit_booking_path(@booking), class: 'booking__update' %>
					<%= link_to 'Pay now', pay_booking_path(@booking), id: 'booking__pay' %>
				<% elsif @booking.confirmed? %>
					<%= link_to 'Update Booking', edit_booking_path(@booking), class: 'booking__update' %>
					<%= button_to 'Cancel Booking', cancel_booking_path(@booking), data: { turbo_confirm: 'Are you sure?' }, method: :patch, class: 'booking__decline' %>
				<% end %>
			</div>

			<% if @host == current_user %>
				<% if @booking.completed? && @host_review.nil? %>
					<%= render 'partials/new-review' %>
				<% elsif @booking.completed? && !@host_review.nil? %>
					<%= render 'partials/review-preview' %>
				<% end %>
			<% else %>
				<% if @booking.completed? && @guest_review.nil? %>
					<%= render 'partials/new-review' %>
				<% elsif @booking.completed? && !@guest_review.nil? %>
					<%= render 'partials/review-preview' %>
				<% end %>
			<% end %>

		</div>
	</div>
</section>